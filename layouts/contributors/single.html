{{ define "main" }}
<section class="home-about">
  <h1><img src="/img/sqlfluff-wide.png" alt="sqlfluff"/><br>{{ .Title }}</h1>
  <p class="contributors-subtitle">{{ .Description }}</p>
</section>

<div class="flex-break"></div>

<div class="post container sqlfluff-justify">
  <div class="post-content">
        {{ .Content }}

    <div class="contributors-controls">
      <label for="time-filter">Show contributions from:</label>
      <select id="time-filter">
        <option value="all">All time</option>
        <option value="year">This year</option>
        <option value="month">This month</option>
        <option value="week">This week</option>
      </select>
    </div>

    <div id="contributors-table"></div>

    <blockquote>
      <p><em>Want to contribute? Check out our <a href="https://github.com/sqlfluff/sqlfluff">GitHub repository</a> and <a href="https://github.com/sqlfluff/sqlfluff/blob/main/CONTRIBUTING.md">contributing guide</a>.</em></p>
    </blockquote>
  </div>
</div>

{{ partial "back-to-top.html" . }}

<!-- Tabulator CSS -->
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">

<!-- Tabulator JS -->
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

<script>
// Dummy contributor data with time-based commit counts
const contributorsData = [
  {
    rank: 1,
    name: "Alan Cruickshank",
    github: "alanmcruickshank",
    since: "2019-03-15",
    commits_all: 1247,
    commits_year: 234,
    commits_month: 3,
    commits_week: 12,
    avatar: "https://github.com/alanmcruickshank.png"
  },
  {
    rank: 2,
    name: "Rick Viscomi",
    github: "tunetheweb",
    since: "2020-01-22",
    commits_all: 892,
    commits_year: 156,
    commits_month: 28,
    commits_week: 7,
    avatar: "https://github.com/tunetheweb.png"
  },
  {
    rank: 3,
    name: "Emily Watson",
    github: "ewatson-sql",
    since: "2020-08-10",
    commits_all: 634,
    commits_year: 89,
    commits_month: 15,
    commits_week: 4,
    avatar: "https://github.com/identicons/ewatson-sql.png"
  },
  {
    rank: 4,
    name: "David Kumar",
    github: "dkumar-data",
    since: "2021-05-03",
    commits_all: 421,
    commits_year: 67,
    commits_month: 11,
    commits_week: 2,
    avatar: "https://github.com/identicons/dkumar-data.png"
  },
  {
    rank: 5,
    name: "Alex Thompson",
    github: "athompson-dev",
    since: "2022-02-14",
    commits_all: 289,
    commits_year: 43,
    commits_month: 8,
    commits_week: 1,
    avatar: "https://github.com/identicons/athompson-dev.png"
  }
];

// Current filter period
let currentPeriod = 'all';

// Function to get commit field based on current period
function getCommitField(period) {
  switch(period) {
    case 'year': return 'commits_year';
    case 'month': return 'commits_month';
    case 'week': return 'commits_week';
    default: return 'commits_all';
  }
}

// Function to prepare data for current period
function prepareDataForPeriod(data, period) {
  const commitField = getCommitField(period);
  return data
    .map(contributor => ({
      ...contributor,
      commits: contributor[commitField] // Map the correct commit count to 'commits' field
    }))
    .sort((a, b) => b.commits - a.commits) // Sort by commits descending
    .map((contributor, index) => ({
      ...contributor,
      rank: index + 1 // Recalculate rank based on current period
    }));
}

// Initialize Tabulator
const table = new Tabulator("#contributors-table", {
  data: prepareDataForPeriod(contributorsData, currentPeriod),
  layout: "fitColumns",
  responsiveLayout: "collapse",
  pagination: "local",
  paginationSize: 25,
  columns: [
    {
      title: "#",
      field: "rank",
      width: 60,
      sorter: "number",
      headerSort: false
    },
    {
      title: "Name",
      field: "name",
      minWidth: 200,
      formatter: function(cell, formatterParams) {
        const data = cell.getRow().getData();
        return `
          <div class="contributor-info">
            <img src="${data.avatar}" alt="${data.name}" class="contributor-avatar">
            <div class="contributor-details">
              <strong>${data.name}</strong><br>
              <a href="https://github.com/${data.github}" target="_blank" rel="noopener">@${data.github}</a>
            </div>
          </div>
        `;
      }
    },
    {
      title: "Since",
      field: "since",
      width: 120,
      formatter: function(cell) {
        const date = new Date(cell.getValue());
        return date.toLocaleDateString('en-US', {
          day: '2-digit',
          month: 'short',
          year: 'numeric'
        });
      },
      sorter: "date"
    },
    {
      title: "Commits",
      field: "commits",
      width: 100,
      formatter: function(cell) {
        return `<a href="https://github.com/sqlfluff/sqlfluff/commits?author=${cell.getRow().getData().github}" target="_blank" rel="noopener">${cell.getValue()}</a>`;
      },
      sorter: "number"
    }
  ],
  initialSort: [
    {column: "commits", dir: "desc"}
  ]
});

// Function to get period text for display
function getPeriodText(period) {
  switch(period) {
    case 'year': return 'this year';
    case 'month': return 'this month';
    case 'week': return 'this week';
    default: return 'of all time';
  }
}

// Function to get title text for display
function getTitleText(period) {
  switch(period) {
    case 'year': return 'SQLFluff Contributors - This year';
    case 'month': return 'SQLFluff Contributors - This month';
    case 'week': return 'SQLFluff Contributors - This week';
    default: return 'SQLFluff Contributors - All time';
  }
}

// Time filter functionality
document.getElementById('time-filter').addEventListener('change', function(e) {
  const filter = e.target.value;
  currentPeriod = filter;

  // Update table data with new time period
  const newData = prepareDataForPeriod(contributorsData, currentPeriod);
  table.replaceData(newData);

  // Update the contributors count, period text, and title display
  document.getElementById('total-contributors').textContent = newData.length;
  document.getElementById('time-period-text').textContent = getPeriodText(currentPeriod);
  document.getElementById('contributors-title').textContent = getTitleText(currentPeriod);

  console.log('Filter changed to:', filter);
});

// Initialize stats and title display
const initialData = prepareDataForPeriod(contributorsData, currentPeriod);
document.getElementById('total-contributors').textContent = initialData.length;
document.getElementById('time-period-text').textContent = getPeriodText(currentPeriod);
document.getElementById('contributors-title').textContent = getTitleText(currentPeriod);
</script>

{{ end }}
